
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- ZERO ZOOM FIX -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Archive | Epoch19</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- 1. THEME VARIABLES --- */
        :root {
            --bg-deep: #020617;
            --admin-primary: #7C3AED; /* Purple */
            --admin-accent: #8B5CF6;
            --alert: #EF4444;
            --success: #10B981;
            --gold: #F59E0B;
            --text-main: #F8FAFC;
            --text-muted: #94A3B8;
            --glass-surface: rgba(15, 23, 42, 0.95);
            --glass-border: rgba(139, 92, 246, 0.3);
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-ui);
            background-color: var(--bg-deep);
            color: var(--text-main);
            min-height: 100vh;
            display: flex; flex-direction: column;
            overflow-x: hidden;
        }

        /* --- 2. BACKGROUND --- */
        .bg-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -5;
            background: linear-gradient(135deg, #020617 0%, #0f172a 100%);
        }
        @media (min-width: 768px) {
            .bg-wrapper {
                background: 
                    linear-gradient(to bottom, rgba(2, 6, 23, 0.85), rgba(2, 6, 23, 0.95)), 
                    url('assets/images/background.png');
                background-size: cover;
                background-position: center;
                background-attachment: fixed;
            }
        }

        /* --- 3. LOADER --- */
        #global-loader {
            position: fixed; inset: 0; z-index: 9999;
            background: var(--bg-deep);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .spinner-ring {
            width: 60px; height: 60px;
            border: 4px solid rgba(124, 58, 237, 0.2);
            border-top: 4px solid var(--admin-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loader-text {
            margin-top: 15px; font-family: var(--font-code);
            font-size: 0.9rem; color: var(--admin-accent); letter-spacing: 2px;
            animation: pulse 1.5s infinite;
        }

        /* --- 4. HEADER & NAV --- */
        header {
            position: fixed; top: 0; width: 100%; z-index: 1000;
            padding: 1rem 5%;
            background: rgba(2, 6, 23, 0.98);
            border-bottom: 1px solid var(--admin-primary);
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand {
            display: flex; align-items: center; gap: 12px;
            font-weight: 700; font-size: 1.2rem; color: #fff; text-decoration: none;
        }
        .user-badge {
            background: rgba(255, 255, 255, 0.1); color: var(--text-muted);
            padding: 4px 10px; border-radius: 4px; font-size: 0.7rem;
            font-weight: 700; text-transform: uppercase; border: 1px solid var(--glass-border);
        }
        .menu-toggle { font-size: 1.8rem; cursor: pointer; color: var(--text-muted); }

        /* Nav Drawer */
        .nav-drawer {
            position: fixed; top: 0; right: -300px;
            width: 280px; height: 100vh;
            background: #0f172a;
            border-left: 1px solid var(--admin-primary);
            z-index: 1001; padding: 6rem 2rem;
            transition: right 0.3s ease;
            display: flex; flex-direction: column; gap: 1rem;
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }
        .nav-drawer.active { right: 0; }
        .nav-item {
            text-decoration: none; color: var(--text-muted);
            font-size: 1rem; display: flex; align-items: center; gap: 15px;
            padding: 12px; border-radius: 6px; transition: 0.3s;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(124, 58, 237, 0.1); color: #fff; border: 1px solid var(--admin-primary);
        }
        .nav-close { position: absolute; top: 20px; right: 20px; font-size: 2rem; cursor: pointer; }

        /* --- 5. MAIN CONTENT --- */
        main {
            margin-top: 80px; padding: 2rem 5%;
            flex: 1; max-width: 1600px; width: 100%; align-self: center;
            display: flex; flex-direction: column; gap: 1.5rem;
        }

        /* Toolbar */
        .toolbar {
            display: flex; flex-direction: column; gap: 1rem;
            background: var(--glass-surface);
            border: 1px solid var(--glass-border);
            padding: 1.5rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        /* Top Row of Toolbar */
        .toolbar-top {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 1rem; width: 100%;
        }

        /* Filter Grid (Initially Hidden or Visible based on design preference - Here visible for ease) */
        .filter-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 10px; width: 100%;
            padding-top: 1rem; border-top: 1px solid var(--glass-border);
        }

        .search-box { position: relative; width: 300px; max-width: 100%; }
        .search-box i {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: var(--text-muted); font-size: 1.2rem;
        }
        
        /* Universal Input Style */
        .search-input, .filter-input, .filter-select {
            width: 100%; padding: 10px 12px;
            background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border);
            border-radius: 8px; color: #fff; outline: none; transition: 0.3s;
            font-family: var(--font-ui); font-size: 0.9rem;
        }
        .search-input { padding-left: 40px; }
        
        .search-input:focus, .filter-input:focus, .filter-select:focus { 
            border-color: var(--admin-primary); 
            box-shadow: 0 0 10px rgba(124, 58, 237, 0.2); 
        }
        .search-input:disabled, .filter-input:disabled, .filter-select:disabled { 
            opacity: 0.5; cursor: not-allowed; 
        }
        
        /* Specific input styling fixes */
        .filter-select { appearance: none; cursor: pointer; }
        .filter-select option { background: var(--bg-deep); color: #fff; }

        .toolbar-actions { display: flex; gap: 10px; align-items: center; }
        .btn-tool {
            padding: 10px 20px; border-radius: 8px; border: 1px solid var(--glass-border);
            background: rgba(124, 58, 237, 0.1); color: var(--text-main);
            cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
            transition: 0.3s; font-weight: 500;
        }
        .btn-tool:hover { background: var(--admin-primary); border-color: var(--admin-primary); }
        .btn-reset:hover { background: var(--alert); border-color: var(--alert); }
        .btn-hidden { display: none; }
        
        .premium-tag {
            color: var(--gold); display: flex; align-items: center; gap: 6px; 
            font-size: 0.85rem; font-weight: 700; font-family: var(--font-code);
            background: rgba(245, 158, 11, 0.1); padding: 8px 12px; border-radius: 6px;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* --- 6. ADVANCED DATA TABLE (Sideways Scroll) --- */
        .table-container {
            position: relative;
            background: var(--glass-surface);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            overflow: hidden; 
            min-height: 500px;
            backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
        }

        .table-scroll { 
            overflow-x: auto; /* Enable Sideways Scroll */
            width: 100%;
            scrollbar-color: var(--admin-primary) rgba(15, 23, 42, 0.5); /* Firefox */
        }

        /* Advanced Scrollbar Styling (Webkit) */
        .table-scroll::-webkit-scrollbar { height: 10px; width: 10px; }
        .table-scroll::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); }
        .table-scroll::-webkit-scrollbar-thumb { 
            background: var(--admin-primary); 
            border-radius: 5px; border: 2px solid rgba(15, 23, 42, 0.5); 
        }
        .table-scroll::-webkit-scrollbar-thumb:hover { background: var(--admin-accent); }

        .data-table { 
            width: 100%; 
            min-width: 900px; /* Forces sideways scroll on small screens */
            border-collapse: collapse; 
            text-align: left; 
            white-space: nowrap; /* Prevents text wrapping to ensure columns hold width */
        }

        .data-table thead th {
            position: sticky; top: 0; z-index: 5;
            background: rgba(15, 23, 42, 0.98);
            padding: 1.2rem 1rem;
            font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
            color: var(--text-muted);
            border-bottom: 2px solid var(--glass-border);
            cursor: pointer; transition: color 0.2s;
        }
        .data-table thead th:hover { color: var(--admin-accent); }
        .data-table thead th i { margin-left: 5px; opacity: 0.5; }

        .data-table tbody tr { border-bottom: 1px solid rgba(255,255,255,0.03); transition: background 0.2s; }
        .data-table tbody tr:hover { background: rgba(124, 58, 237, 0.05); }

        .data-table td {
            padding: 1rem; font-family: var(--font-code); font-size: 0.9rem; color: var(--text-main);
        }

        /* Data Colors */
        .val-deaths { color: var(--alert); font-weight: 700; }
        .val-mild { color: var(--text-muted); }
        .val-success { color: var(--success); }
        .val-serious { color: var(--gold); }

        /* --- 7. OVERLAYS (Paywall & Loader) --- */
        
        /* Paywall */
        .paywall-active .table-scroll {
            mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
            overflow: hidden; max-height: 600px;
        }

        .paywall-lock {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 350px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10;
            background: linear-gradient(to top, #020617 20%, transparent);
            pointer-events: all;
        }
        
        .lock-icon { 
            font-size: 3rem; color: var(--gold); margin-bottom: 1rem; 
            filter: drop-shadow(0 0 10px rgba(245, 158, 11, 0.5));
            animation: bounce 2s infinite; 
        }
        
        .btn-unlock {
            background: linear-gradient(135deg, var(--gold), #d97706);
            color: #fff;
            padding: 12px 30px; border-radius: 30px; border: none;
            font-weight: 700; font-size: 1rem;
            cursor: pointer; box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
            transition: 0.3s;
            margin-top: 15px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-unlock:hover { transform: scale(1.05); box-shadow: 0 15px 30px rgba(245, 158, 11, 0.5); }

        /* Internal Loader */
        .loader-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(2,6,23,0.9); z-index: 20;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .scanner-line {
            width: 100%; height: 2px; background: var(--admin-primary);
            box-shadow: 0 0 15px var(--admin-primary);
            animation: scan 1.5s infinite linear;
        }
        .scan-box {
            width: 60px; height: 60px; border: 2px solid var(--admin-primary); 
            position: relative; overflow: hidden;
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.2);
        }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes scan { 0% { transform: translateY(-20px); opacity:0; } 50% { opacity:1; } 100% { transform: translateY(60px); opacity:0; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- 8. FOOTER --- */
        footer {
            margin-top: auto; border-top: 1px solid var(--glass-border);
            padding: 2.5rem 5% 1.5rem; background: rgba(2, 6, 23, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            gap: 1.5rem; text-align: center;
        }

        .footer-socials { display: flex; gap: 25px; }
        .footer-socials a {
            color: var(--text-muted); font-size: 1.6rem;
            transition: all 0.3s ease; width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border); text-decoration: none;
        }
        .footer-socials a:hover {
            color: #fff; background: var(--admin-primary);
            border-color: var(--admin-primary); transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.3);
        }
        .copyright-text { font-family: var(--font-code); opacity: 0.6; font-size: 0.8rem; letter-spacing: 0.5px; }

        /* RESPONSIVE */
        @media(max-width: 768px) {
            .toolbar { padding: 1rem; }
            .toolbar-top { flex-direction: column; align-items: stretch; }
            .toolbar-actions { flex-direction: column; }
            .btn-tool { justify-content: center; }
            .premium-tag { justify-content: center; }
            .search-box { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="bg-wrapper"></div>

    <!-- Preloader -->
    <div id="global-loader">
        <div class="spinner-ring"></div>
        <div class="loader-text">ACCESSING ARCHIVE...</div>
    </div>

    <!-- Header -->
    <header>
        <a href="dashboard.html" class="brand">
            <img src="assets/images/logo.png" alt="Epoch19" style="height: 30px;">
            <span>EPOCH19 <span class="user-badge">ARCHIVE</span></span>
        </a>
        <i class='bx bx-menu menu-toggle' onclick="toggleNav()"></i>
    </header>

    <!-- Nav Drawer -->
    <aside class="nav-drawer" id="navDrawer">
        <i class='bx bx-x nav-close' onclick="toggleNav()"></i>
        <div style="padding: 0 12px; margin-bottom: 1rem;">
            <p style="font-size: 0.8rem; color: var(--admin-primary); font-weight: 700;">NAVIGATION</p>
        </div>
        <a href="dashboard.html" class="nav-item"><i class='bx bx-grid-alt'></i> Dashboard</a>
        <a href="database.html" class="nav-item active"><i class='bx bx-data'></i> Data Archive</a>
        <a href="resources.html" class="nav-item"><i class='bx bx-news'></i> Resources</a>
        <a href="settings.html" class="nav-item"><i class='bx bx-cog'></i> Settings</a>
        <a href="upgrade.html" class="nav-item" style="color: var(--gold);"><i class='bx bx-crown'></i> Upgrade</a>
        
        <div style="margin-top: auto;">
            <a href="#" class="nav-item" id="btn-logout" style="color: var(--alert);"><i class='bx bx-power-off'></i> Logout</a>
        </div>
    </aside>

    <!-- Main Content -->
    <main>
        
        <!-- Advanced Toolbar -->
        <div class="toolbar">
            <!-- Top Row: Search & Actions -->
            <div class="toolbar-top">
                <div class="search-box">
                    <i class='bx bx-search'></i>
                    <input type="text" class="search-input" id="table-search" placeholder="Search Country or Date..." disabled>
                </div>
                
                <div class="toolbar-actions">
                    <div id="premium-badge" class="premium-tag" style="display:none;">
                        <i class='bx bxs-check-circle'></i> UNLOCKED
                    </div>
                    <button class="btn-tool btn-hidden" id="btn-export-csv">
                        <i class='bx bxs-file-export'></i> CSV
                    </button>
                    <button class="btn-tool btn-reset btn-hidden" id="btn-reset-filters">
                        <i class='bx bx-refresh'></i> RESET
                    </button>
                </div>
            </div>

            <!-- Bottom Row: Advanced Filters -->
            <div class="filter-grid" id="advanced-filters" style="display:none; opacity: 0.5;">
                
                <!-- Date Range -->
                <div>
                    <input type="text" class="filter-input" id="filter-date-start" placeholder="Start Date (DD/MM/YYYY)" disabled>
                </div>
                <div>
                    <input type="text" class="filter-input" id="filter-date-end" placeholder="End Date (DD/MM/YYYY)" disabled>
                </div>

                <!-- Country Dropdown -->
                <div>
                    <select class="filter-select" id="filter-country" disabled>
                        <option value="">All Countries</option>
                        <!-- Options injected by JS -->
                    </select>
                </div>

                <!-- Min Cases -->
                <div>
                    <input type="number" class="filter-input" id="filter-min-cases" placeholder="Min Cases" disabled>
                </div>

                <!-- Min Deaths -->
                <div>
                    <input type="number" class="filter-input" id="filter-min-deaths" placeholder="Min Deaths" disabled>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="table-container" id="table-wrapper">
            
            <!-- Internal Loader -->
            <div class="loader-overlay" id="table-loader">
                <div style="margin-bottom: 20px; font-family: var(--font-code); color: var(--admin-accent); letter-spacing: 2px;">DECRYPTING DATA...</div>
                <div class="scan-box">
                    <div class="scanner-line"></div>
                </div>
            </div>

            <!-- Paywall Overlay -->
            <div class="paywall-lock" id="paywall-overlay" style="display: none;">
                <i class='bx bxs-lock-alt lock-icon'></i>
                <h3 style="color: white; margin-bottom: 5px; font-family: var(--font-ui);">Restricted Access</h3>
                <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.9rem;">Upgrade required to view historical records & use filters.</p>
                <button class="btn-unlock" onclick="window.location.href='upgrade.html'">Unlock Access ($5)</button>
            </div>

            <!-- Advanced Scrollable Table -->
            <div class="table-scroll">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-sort="Date">Date <i class='bx bx-sort'></i></th>
                            <th data-sort="Country">Country <i class='bx bx-sort'></i></th>
                            <th data-sort="Cases">Cases <i class='bx bx-sort'></i></th>
                            <th data-sort="Deaths">Deaths <i class='bx bx-sort'></i></th>
                            <th data-sort="Recovered">Recovered <i class='bx bx-sort'></i></th>
                            <th data-sort="Mild">Mild <i class='bx bx-sort'></i></th>
                            <th data-sort="Serious">Serious <i class='bx bx-sort'></i></th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Data Injected Here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-socials">
            <a id="link-email" href="#" title="Email Support"><i class='bx bx-envelope'></i></a>
            <a id="link-whatsapp" href="#" title="WhatsApp Support"><i class='bx bxl-whatsapp'></i></a>
        </div>
        <div class="copyright-text">
            Epoch19 Data Archive &copy; 2025
        </div>
    </footer>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, query, limit, orderBy, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDlWM9hfnreQMAXze5q5o2jr_Z9ekYxE2M",
            authDomain: "epoch19-479ca.firebaseapp.com",
            projectId: "epoch19-479ca",
            storageBucket: "epoch19-479ca.firebasestorage.app",
            messagingSenderId: "608813445980",
            appId: "1:608813445980:web:08ab4dedc8ddc71e670799",
            measurementId: "G-JKR6K20LSL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let globalData = []; 
        let isPremium = false;
        let sortDirection = 1;

        // 1. Auth Check
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    isPremium = userData.status === 'premium' || userData.role === 'admin';
                    
                    setupUI(isPremium);
                    loadData(isPremium);
                    loadFooterLinks();
                    
                    // Hide Global Loader
                    const loader = document.getElementById('global-loader');
                    loader.style.opacity = '0';
                    setTimeout(() => { loader.style.display = 'none'; }, 500);
                }
            }
        });

        // 2. Setup UI & Filters
        function setupUI(premium) {
            const els = {
                search: document.getElementById('table-search'),
                export: document.getElementById('btn-export-csv'),
                reset: document.getElementById('btn-reset-filters'),
                badge: document.getElementById('premium-badge'),
                filtersDiv: document.getElementById('advanced-filters'),
                dateStart: document.getElementById('filter-date-start'),
                dateEnd: document.getElementById('filter-date-end'),
                country: document.getElementById('filter-country'),
                minCases: document.getElementById('filter-min-cases'),
                minDeaths: document.getElementById('filter-min-deaths')
            };

            if (premium) {
                // Enable All Inputs
                Object.values(els).forEach(el => {
                    if(el.tagName === 'INPUT' || el.tagName === 'SELECT') el.disabled = false;
                });

                els.search.placeholder = "Quick Search...";
                els.export.classList.remove('btn-hidden');
                els.reset.classList.remove('btn-hidden');
                els.badge.style.display = 'flex';
                els.filtersDiv.style.display = 'grid';
                els.filtersDiv.style.opacity = '1';

                // Listeners
                const inputs = [els.search, els.dateStart, els.dateEnd, els.country, els.minCases, els.minDeaths];
                inputs.forEach(inp => inp.addEventListener('input', applyFilters));
                els.country.addEventListener('change', applyFilters);

                els.export.addEventListener('click', exportCSV);
                els.reset.addEventListener('click', () => {
                    inputs.forEach(inp => inp.value = "");
                    applyFilters();
                });

                document.querySelectorAll('th[data-sort]').forEach(th => {
                    th.addEventListener('click', () => sortTable(th.getAttribute('data-sort')));
                });
            }
        }

        // 3. Load Data
        async function loadData(premium) {
            try {
                let q;
                if (premium) {
                    q = query(collection(db, "covid_data"), orderBy("Date", "desc")); 
                } else {
                    q = query(collection(db, "covid_data"), limit(15));
                }

                const querySnapshot = await getDocs(q);
                
                globalData = [];
                const countries = new Set();

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    globalData.push(data);
                    if(data.Country) countries.add(data.Country);
                });

                // Populate Country Dropdown
                if(premium) {
                    const countrySelect = document.getElementById('filter-country');
                    Array.from(countries).sort().forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c;
                        opt.innerText = c;
                        countrySelect.appendChild(opt);
                    });
                }

                renderTable(globalData);
                document.getElementById('table-loader').style.display = 'none';

                if (!premium) {
                    document.getElementById('table-wrapper').classList.add('paywall-active');
                    document.getElementById('paywall-overlay').style.display = 'flex';
                }

            } catch (error) {
                console.error("Data Load Error:", error);
                Swal.fire({
                    toast: true, position: 'top-end', icon: 'error', 
                    title: 'Failed to retrieve archive', background: '#020617', color:'#fff'
                });
            }
        }

        // 4. Render Table
        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 2rem; color: #94A3B8;">No records found matching filters.</td></tr>`;
                return;
            }

            data.forEach(row => {
                const tr = document.createElement('tr');
                const deathsClass = (Number(row.Deaths) > 1000) ? 'val-deaths' : '';
                const seriousClass = (Number(row.Serious) > 500) ? 'val-serious' : '';
                
                tr.innerHTML = `
                    <td style="color: var(--admin-accent);">${row.Date || '--'}</td>
                    <td><span style="font-weight:600; color:#fff">${row.Country}</span></td>
                    <td>${Number(row.Cases).toLocaleString()}</td>
                    <td class="${deathsClass}">${Number(row.Deaths).toLocaleString()}</td>
                    <td class="val-success">${Number(row.Recovered || 0).toLocaleString()}</td>
                    <td class="val-mild">${Number(row.Mild).toLocaleString()}</td>
                    <td class="${seriousClass}">${Number(row.Serious).toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 5. Advanced Filter Logic
        function applyFilters() {
            const searchVal = document.getElementById('table-search').value.toLowerCase();
            const countryVal = document.getElementById('filter-country').value;
            const minCases = Number(document.getElementById('filter-min-cases').value) || 0;
            const minDeaths = Number(document.getElementById('filter-min-deaths').value) || 0;
            
            // Helper: Parse Date DD/MM/YYYY to timestamp
            const parseDate = (str) => {
                if(!str) return null;
                const [d,m,y] = str.split('/');
                if(!d || !m || !y) return null;
                return new Date(`${y}-${m}-${d}`).getTime();
            };

            const startTs = parseDate(document.getElementById('filter-date-start').value);
            const endTs = parseDate(document.getElementById('filter-date-end').value);

            const filtered = globalData.filter(item => {
                // Text Search
                const matchesText = !searchVal || 
                    (item.Country && item.Country.toLowerCase().includes(searchVal)) ||
                    (item.Date && item.Date.includes(searchVal));

                // Country Dropdown
                const matchesCountry = !countryVal || item.Country === countryVal;

                // Numeric Thresholds
                const matchesCases = (Number(item.Cases) || 0) >= minCases;
                const matchesDeaths = (Number(item.Deaths) || 0) >= minDeaths;

                // Date Range
                let matchesDate = true;
                if(startTs || endTs) {
                    const itemTs = parseDate(item.Date);
                    if(!itemTs) matchesDate = false; // Filter out invalid dates if range active
                    else {
                        if(startTs && itemTs < startTs) matchesDate = false;
                        if(endTs && itemTs > endTs) matchesDate = false;
                    }
                }

                return matchesText && matchesCountry && matchesCases && matchesDeaths && matchesDate;
            });

            renderTable(filtered);
        }

        // 6. Sort
        function sortTable(column) {
            sortDirection *= -1;
            // First get the currently filtered data so we sort what's visible
            // But for simplicity, we resort global, then re-apply filter logic implicitly via render
            // NOTE: A better way is to sort globalData, then re-run applyFilters()
            
            globalData.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                if (['Cases', 'Deaths', 'Recovered', 'Mild', 'Serious'].includes(column)) {
                    valA = Number(valA) || 0;
                    valB = Number(valB) || 0;
                } else if (column === 'Date') {
                    // Convert DD/MM/YYYY to sortable format
                    const toDate = (d) => {
                        if(!d) return 0;
                        const [day, mon, yr] = d.split('/');
                        return new Date(`${yr}-${mon}-${day}`).getTime();
                    };
                    valA = toDate(valA);
                    valB = toDate(valB);
                }

                if (valA < valB) return -1 * sortDirection;
                if (valA > valB) return 1 * sortDirection;
                return 0;
            });

            applyFilters(); // Re-render with sorted data
        }

        // 7. Export
        function exportCSV() {
            // Get currently visible rows only? Or all loaded? 
            // Let's export currently filtered data for utility
            // To do that, we effectively re-run logic or store filtered state. 
            // For simplicity, we filter globalData again here.
            
            // Re-running a quick filter to get the array
            // ( Ideally store 'filteredData' in a global variable in applyFilters )
            const rows = document.querySelectorAll('#table-body tr');
            if(rows.length === 0 || rows[0].innerText.includes('No records')) return;

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Country,Cases,Deaths,Recovered,Mild,Serious\n";

            // We iterate globalData using same filter logic to get raw data
            // OR simpler: iterate table rows (but that loses raw precision sometimes). 
            // Let's re-use globalData to be safe.
            
            // NOTE: For brevity, I am exporting the FULL dataset here. 
            // If you want filtered only, we'd need to extract the filtering logic.
            // Let's assume user wants full dump if they click export, or you can uncomment below:
            /* 
               const filtered = ... (logic from applyFilters) ...
               filtered.forEach(...) 
            */

            globalData.forEach(row => {
                const rowStr = `${row.Date},${row.Country},${row.Cases},${row.Deaths},${row.Recovered || 0},${row.Mild},${row.Serious}`;
                csvContent += rowStr + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "epoch19_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 8. Footer Links
        async function loadFooterLinks() {
            try {
                const configSnap = await getDoc(doc(db, "config", "main_settings"));
                if (configSnap.exists()) {
                    const data = configSnap.data();
                    if(data.contact_email) document.getElementById('link-email').href = `mailto:${data.contact_email}`;
                    if(data.contact_whatsapp) document.getElementById('link-whatsapp').href = `https://wa.me/${data.contact_whatsapp}`;
                }
            } catch (e) {}
        }

        window.toggleNav = () => document.getElementById('navDrawer').classList.toggle('active');
        document.getElementById('btn-logout').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "index.html");
        });
    </script>
</body>
</html>
